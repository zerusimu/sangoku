<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= general.name %> の個人画面</title>

<style>
.map {
  display: grid;
  grid-template-columns: repeat(10, 60px);
  grid-template-rows: repeat(10, 60px);
  gap: 4px;
}

.map-cell {
  border: 1px solid #555;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.map-cell.mine { background: #4caf50; color: white; }
.map-cell.enemy { background: #f44336; color: white; }
.map-cell.neutral { background: #ccc; }

.container {
  display: flex;
  gap: 20px;
}

.left, .right {
  padding: 10px;
  border: 1px solid #ccc;
}

.left { width: 40%; }
.right { width: 60%; }

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #999;
  padding: 4px;
  text-align: center;
}
</style>
</head>

<body>
<div class="container">

<!-- ================= 左 ================= -->
<div class="left">
  <p><a href="/countries">国一覧へ</a></p>

  <h1>名前：<%= general.name %></h1>
  <p>武力: <%= general.str %></p>
  <p>知力: <%= general.int %></p>
  <p>統率: <%= general.lea %></p>
  <p>魅力: <%= general.cha %></p>
  <p>訓練: <%= general.kunren %></p>
 <p>お金: <%= general.money %></p>

  <% if (country) { %>
    <h2>所属国</h2>
    <p>国名: <%= country.name %></p>
    <p>君主: <%= country.ruler %></p>
  <% } else { %>
    <p>無所属</p>
  <% } %>

  <hr>

  <h3>勢力マップ</h3>
  <div class="map">
<% cities.forEach(city => { %>
  <% 
    let cls = "neutral";
    if (city.owner === general.countryId) {
      cls = "mine";
    } else if (city.owner) {
      cls = "enemy";
    }
  %>

  <div class="map-cell <%= cls %>"style="grid-column:<%= city.x ?? 1 %>; grid-row:<%= city.y ?? 1 %>;"title="<%= city.name %>（兵 <%= city.soldiers %>）">
    <%= city.name %>
  </div>
<% }) %>

  </div>

<h2>過去のコマンドログ</h2>

<table border="1">
  <tr>
    <th>実行時刻</th>
    <th>コマンド</th>
    <th>内容</th>
  </tr>

  <% if (commandLog.length === 0) { %>
    <tr>
      <td colspan="3">まだ実行されたコマンドはありません</td>
    </tr>
  <% } %>

  <% commandLog.slice().reverse().forEach(log => { %>
    <tr>
      <td><%= new Date(log.executeAt).toLocaleString() %></td>
      <td><%= log.type %></td>
      <td>
        <% if (log.type === "tyouhei") { %>
          兵種: <%= log.data.heisyuId %>,
          数: <%= log.data.count %>
        <% } else { %>
          -
        <% } %>
      </td>
    </tr>
  <% }) %>
</table>


</div>

<!-- ================= 右 ================= -->
<div class="right">

<p style="color:red">
  DEBUG baseTime:
  <%= new Date(general.scheduleBaseTime).toLocaleString() %>
</p>

<h3>一括設定</h3>
<select id="bulkCommand">
  <option value="">--一括命令--</option>
  <option value="kunren">訓練</option>
  
  <option value="tyouhei">徴兵</option>
</select>
<button type="button" onclick="applyBulk()">一括反映</button>
<hr>

<form action="/command/update" method="post">

<table>
  <tr>
    <th>コマ</th>
    <th>実行予定</th>
    <th>命令</th>
  </tr>

<% schedule.forEach(s => { %>
<tr>
  <td><%= s.index + 1 %></td>
  <td>
   <span class="schedule-time"
        data-index="<%= s.index %>"></span>

  </td>
  <td>
    <!-- 命令 -->
<select
  class="command-select"name="commands[<%= s.index %>]"onchange="onCommandChange(this, <%= s.index %>)">

  <option value="" <%= s.command === "" ? "selected" : "" %>>（空）</option>
  <option value="kunren" <%= s.command === "kunren" ? "selected" : "" %>>訓練</option>
<option value="tyouhei" <%= s.command === "tyouhei" ? "selected" : "" %>>徴兵</option>
</select>


    <!-- 徴兵入力 -->
<div class="tyouhei-input"style="<%= s.command === 'tyouhei' ? '' : 'display:none;' %>">

  <select name="tyouhei_heisyu[<%= s.index %>]">
    <% heisyu.forEach(h => { %>
   <option value="<%= h.id %>"
  <%= s.heisyuId === h.id ? "selected" : "" %>>
  <%= h.name %>
</option>
    <% }) %>
  </select>

  <input type="number"
         name="tyouhei_count[<%= s.index %>]"
         min="1"
         value="<%= s.count || 1 %>">
</div>

  </td>
</tr>
<% }) %>

</table>

<br>
<button type="submit">保存</button>
</form>

</div>
</div>

<script>

let isBulkApplying = false;

function onCommandChange(select, index) {
  if (isBulkApplying) return; // ★ 一括時は遷移しない

  if (select.value === "tyouhei") {
    location.href = `/recruit/${index}`;
  }
}

function applyBulk() {
  const value = document.getElementById("bulkCommand").value;
  if (!value) return;

  document.querySelectorAll(".command-select").forEach((sel, index) => {
    sel.value = value;

    // ✅ 訓練はその場で反映
    if (value === "kunren") {
      sel.dispatchEvent(new Event("change"));
    }

    // ❌ 徴兵は画面遷移させない（bulk 専用ページを使う）
  });
}


document.querySelectorAll("tr").forEach(row => {
  const select = row.querySelector(".command-select");
  const box = row.querySelector(".tyouhei-input");
  if (!select || !box) return;

  const update = () => {
    box.style.display = select.value === "tyouhei" ? "block" : "none";
  };

  select.addEventListener("change", update);
  update();
});

const BASE_TIME = <%= general.scheduleBaseTime %>;
const INTERVAL = <%= intervalMinutes %> * 60 * 1000;

function updateScheduleTime() {
  document.querySelectorAll(".schedule-time").forEach(el => {
    const index = Number(el.dataset.index);
    const time = new Date(BASE_TIME + index    * INTERVAL);

    el.innerHTML =
      time.toLocaleDateString("ja-JP") + "<br>" +
      time.toLocaleTimeString("ja-JP");
  });
}

updateScheduleTime();
setInterval(updateScheduleTime, 1000);
</script>

</body>
</html>
